<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cctoolkit.cosmology &mdash; CCToolkit 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CCToolkit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CCToolkit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">cctoolkit.cosmology</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cctoolkit.cosmology</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">cosmology.py</span>

<span class="sd">This module defines the CosmologyCalculator class, which manages cosmological</span>
<span class="sd">parameters and calculations related to the power spectrum and other cosmological</span>
<span class="sd">quantities using CAMB.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">camb</span> <span class="kn">import</span> <span class="n">CAMBparams</span><span class="p">,</span> <span class="n">get_results</span><span class="p">,</span> <span class="n">model</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">CAMBparams</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">get_results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">compute_sigma8_norm</span><span class="p">,</span> <span class="n">ssq_given_Dk</span><span class="p">,</span> <span class="n">d_s_given_Dk</span>
<span class="kn">from</span> <span class="nn">.hmf</span> <span class="kn">import</span> <span class="n">multiplicity_function</span><span class="p">,</span> <span class="n">best_fit_values_AHF</span><span class="p">,</span> <span class="n">best_fit_values_ROCKSTAR</span><span class="p">,</span> <span class="n">best_fit_values_SUBFIND</span><span class="p">,</span> <span class="n">best_fit_values_VELOCIraptor</span>
<span class="kn">from</span> <span class="nn">.bias</span> <span class="kn">import</span> <span class="n">corrected_bias</span>

<span class="n">best_fits</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AHF&#39;</span><span class="p">:</span> <span class="n">best_fit_values_AHF</span><span class="p">,</span>
             <span class="s1">&#39;ROCKSTAR&#39;</span><span class="p">:</span> <span class="n">best_fit_values_ROCKSTAR</span><span class="p">,</span>
             <span class="s1">&#39;SUBFIND&#39;</span><span class="p">:</span> <span class="n">best_fit_values_SUBFIND</span><span class="p">,</span>
             <span class="s1">&#39;VELOCIraptor&#39;</span><span class="p">:</span> <span class="n">best_fit_values_VELOCIraptor</span><span class="p">}</span>

<div class="viewcode-block" id="CosmologyCalculator">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator">[docs]</a>
<span class="k">class</span> <span class="nc">CosmologyCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to handle cosmological calculations using CAMB.</span>

<span class="sd">    This class facilitates the calculation of various cosmological quantities, including</span>
<span class="sd">    power spectra, density parameters, and functions related to the Halo Mass Function (HMF).</span>
<span class="sd">    It includes methods for calculating the Peak Background Split (PBS) bias and corrected bias,</span>
<span class="sd">    utilizing the CAMB library.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    -----------</span>
<span class="sd">    params : dict</span>
<span class="sd">        Cosmological parameters for the model, including &#39;H0&#39;, &#39;Ob0&#39;, &#39;Om0&#39;, &#39;sigma8&#39;, &#39;ns&#39;, &#39;As&#39;, &#39;tau&#39;, &#39;TCMB&#39;, and &#39;mnu&#39;.</span>
<span class="sd">    cosmo : object</span>
<span class="sd">        An instance of CAMB results, containing cosmological data.</span>
<span class="sd">    k : np.ndarray</span>
<span class="sd">        Array of wavenumbers used in the power spectrum calculations.</span>
<span class="sd">    Pk : dict</span>
<span class="sd">        Dictionary where keys are redshifts and values are arrays of the power spectrum values.</span>
<span class="sd">    Dk : dict</span>
<span class="sd">        Dictionary where keys are redshifts and values are arrays of dimensionless power spectrum values.</span>
<span class="sd">    z_vals : np.ndarray</span>
<span class="sd">        Array of redshift values used for power spectrum calculations.</span>

<span class="sd">    Methods:</span>
<span class="sd">    --------</span>
<span class="sd">    delta_c(Om, z=None):</span>
<span class="sd">        Calculates the critical density contrast (delta_c) for a given matter density.</span>
<span class="sd">    get_power_spectrum(z):</span>
<span class="sd">        Returns the wavenumbers and dimensionless power spectrum at a given redshift.</span>
<span class="sd">    set_cosmology(new_params):</span>
<span class="sd">        Updates the cosmological parameters and recalculates the power spectrum normalization.</span>
<span class="sd">    Omega_m(z):</span>
<span class="sd">        Returns the matter density parameter Omega_m as a function of redshift.</span>
<span class="sd">    Omega_nu(z):</span>
<span class="sd">        Returns the neutrino density parameter Omega_nu as a function of redshift.</span>
<span class="sd">    Omega_k(z):</span>
<span class="sd">        Returns the curvature density parameter Omega_k as a function of redshift.</span>
<span class="sd">    Omega_DE(z):</span>
<span class="sd">        Returns the dark energy density parameter Omega_DE as a function of redshift.</span>
<span class="sd">    critical_density(z):</span>
<span class="sd">        Returns the critical density at a given redshift.</span>
<span class="sd">    H(z):</span>
<span class="sd">        Returns the Hubble parameter H at a given redshift.</span>
<span class="sd">    peak_height(M, z):</span>
<span class="sd">        Calculates the peak-height delta_c / sigma(R(M), z) for a given mass and redshift.</span>
<span class="sd">    lagrangian_radius(M):</span>
<span class="sd">        Calculates the radius of the Lagrangian patch corresponding to a given mass M.</span>
<span class="sd">    sigma(R, z):</span>
<span class="sd">        Calculates the RMS fluctuation sigma(R, z) for a given radius and redshift.</span>
<span class="sd">    dlnsigma_dlnR(R):</span>
<span class="sd">        Calculates the derivative of the logarithm of sigma with respect to the logarithm of R.</span>
<span class="sd">    vfv(M, z, return_variables=False, halo_finder=best_fit_values_ROCKSTAR):</span>
<span class="sd">        Calculates the multiplicity function νf(ν) and related variables for a given mass and redshift.</span>
<span class="sd">    dndlnM(M, z, halo_finder=&#39;ROCKSTAR&#39;):</span>
<span class="sd">        Calculates the halo mass function dn/dlnM, representing the number density of halos per logarithmic mass interval.</span>
<span class="sd">    pbs_bias(M, z, halo_finder=&#39;ROCKSTAR&#39;, return_variables=False):</span>
<span class="sd">        Calculates the PBS bias for halos of mass M at redshift z.</span>
<span class="sd">    bias(M, z, halo_finder=&#39;ROCKSTAR&#39;):</span>
<span class="sd">        Calculates the corrected linear halo bias for given mass and redshift, using the PBS prediction and correction factors.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - This class requires CAMB to be installed and available for the power spectrum calculations.</span>
<span class="sd">    - The methods assume that the input masses (M) are in units of solar masses over h (M_sun/h), and distances (R) are in Mpc/h.</span>
<span class="sd">    - The halo finder parameters must be provided correctly to ensure accurate mass function and bias calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">power_spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;cdm+b&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the CosmologyCalculator with given cosmological parameters.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        params : dict</span>
<span class="sd">            Dictionary containing the cosmological parameters, including &#39;H0&#39;, &#39;Ob0&#39;, &#39;Om0&#39;, &#39;sigma8&#39;,</span>
<span class="sd">            &#39;ns&#39;, &#39;As&#39;, &#39;tau&#39;, &#39;TCMB&#39;, and &#39;mnu&#39;.</span>
<span class="sd">        power_spectrum : array, optional</span>
<span class="sd">            Array containing the power spectrum data (k and Pk). If None, the power spectrum</span>
<span class="sd">            will be computed from the parameters using CAMB.</span>
<span class="sd">        zmax : float, optional</span>
<span class="sd">            Maximum redshift for the calculation. Default is 2.0.</span>
<span class="sd">        nz : int, optional</span>
<span class="sd">            Number of redshift points. Default is 100.</span>
<span class="sd">        var : str, optional</span>
<span class="sd">            Which variable to use to compute the matter power spectrum. Default is &#39;cdm+b&#39; (no neutrinos).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">=</span> <span class="n">zmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">=</span> <span class="n">nz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_z_vals_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">nz</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;cdm+b&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_var</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;tot&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_var</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not supported matter power-spectrum for var=</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">power_spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;When using a custom power-spectrum zmax should be 0 and nz 1!</span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                                   Control the redshift evolution changing sigma8 accordingly.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_power_spectrum</span><span class="p">(</span><span class="n">power_spectrum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_camb</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">background_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_camb</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize_camb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">background_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize CAMB with the given cosmological parameters.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        params : dict</span>
<span class="sd">            Dictionary containing the cosmological parameters.</span>
<span class="sd">        background_only: bool</span>
<span class="sd">            Whether matter power-spectrum is expected to be computed or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">CAMBparams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">get_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;CAMB is not installed or not available.&quot;</span><span class="p">)</span>
        
        <span class="n">camb_params</span> <span class="o">=</span> <span class="n">CAMBparams</span><span class="p">()</span>
        <span class="n">camb_params</span><span class="o">.</span><span class="n">set_cosmology</span><span class="p">(</span>
            <span class="n">H0</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H0&#39;</span><span class="p">],</span>
            <span class="n">ombh2</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Ob0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H0&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">omch2</span><span class="o">=</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Om0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Ob0&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H0&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">TCMB</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TCMB&#39;</span><span class="p">,</span> <span class="mf">2.7255</span><span class="p">),</span>  <span class="c1"># Default CMB temperature is 2.7255 K</span>
            <span class="n">mnu</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mnu&#39;</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">),</span>  <span class="c1"># Default sum of neutrino masses in eV</span>
            <span class="n">num_massive_neutrinos</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_massive_neutrinos&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Number of massive neutrinos</span>
        <span class="p">)</span>
        <span class="n">camb_params</span><span class="o">.</span><span class="n">set_dark_energy</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;w0&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> 
                                    <span class="n">cs2</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> 
                                    <span class="n">wa</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wa&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">dark_energy_model</span><span class="o">=</span><span class="s1">&#39;ppf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">background_only</span><span class="p">:</span>
            <span class="n">camb_params</span><span class="o">.</span><span class="n">InitPower</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">As</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="mf">2e-9</span><span class="p">),</span> <span class="n">ns</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">])</span>
            <span class="n">camb_params</span><span class="o">.</span><span class="n">set_matter_power</span><span class="p">(</span><span class="n">redshifts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_z_vals_inv</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">k_per_logint</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">get_results</span><span class="p">(</span><span class="n">camb_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cosmo</span> <span class="o">=</span> <span class="n">results</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">background_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_vals</span><span class="p">,</span> <span class="n">Pk</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_matter_power_spectrum</span><span class="p">(</span><span class="n">minkh</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">maxkh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">var1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transfer_var</span><span class="p">,</span> <span class="n">var2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transfer_var</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Dk</span> <span class="o">=</span> <span class="n">Pk</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Dk</span> <span class="o">/=</span> <span class="n">compute_sigma8_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Dk</span> <span class="o">=</span> <span class="p">{</span><span class="n">z</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vals</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">_load_power_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">power_spectrum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the power spectrum data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        power_spectrum_file : str</span>
<span class="sd">            Path to the file containing the power spectrum data (k and Pk).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">Pk</span> <span class="o">=</span> <span class="n">power_spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Dk</span> <span class="o">=</span> <span class="n">Pk</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Dk</span> <span class="o">/=</span> <span class="n">compute_sigma8_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Dk</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Dk</span><span class="p">}</span>

<div class="viewcode-block" id="CosmologyCalculator.delta_c">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.delta_c">[docs]</a>
    <span class="k">def</span> <span class="nf">delta_c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Om</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the critical density contrast (delta_c) using Bryan and Norman fit.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        Om : float or callable</span>
<span class="sd">            Matter density parameter. If callable, it should return Om as a function of z.</span>
<span class="sd">        z : float or array-like, optional</span>
<span class="sd">            Redshift at which to evaluate Om if Om is a function.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The critical density contrast delta_c.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="mf">20.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">12.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.012299</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Om</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="mf">20.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">12.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.012299</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Om</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span></div>

    
<div class="viewcode-block" id="CosmologyCalculator.get_power_spectrum">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.get_power_spectrum">[docs]</a>
    <span class="k">def</span> <span class="nf">get_power_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the wavenumber and dimensionless power spectrum arrays at a given redshift.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        z : float, optional</span>
<span class="sd">            Redshift at which to get the power spectrum. Default is 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        tuple</span>
<span class="sd">            (k, Dk) where k is the array of wavenumbers and Dk is the dimensionless power spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dk</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dk</span><span class="p">[</span><span class="n">z</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Power spectrum for redshift z=</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2"> not available.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CosmologyCalculator.set_cosmology">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.set_cosmology">[docs]</a>
    <span class="k">def</span> <span class="nf">set_cosmology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update cosmological parameters and recalculate the power spectrum normalization.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        new_params : dict</span>
<span class="sd">            Dictionary of new cosmological parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">new_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_camb</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span></div>


<div class="viewcode-block" id="CosmologyCalculator.Omega_m">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.Omega_m">[docs]</a>
    <span class="k">def</span> <span class="nf">Omega_m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the matter density parameter Omega_m at a given redshift.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The matter density parameter Omega_m at redshift z.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">get_Omega</span><span class="p">(</span><span class="s1">&#39;cdm&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">get_Omega</span><span class="p">(</span><span class="s1">&#39;baryon&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CosmologyCalculator.Omega_nu">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.Omega_nu">[docs]</a>
    <span class="k">def</span> <span class="nf">Omega_nu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the neutrino density parameter Omega_nu at a given redshift.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The neutrino density parameter Omega_nu at redshift z.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">get_Omega</span><span class="p">(</span><span class="s1">&#39;nu&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CosmologyCalculator.Omega_k">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.Omega_k">[docs]</a>
    <span class="k">def</span> <span class="nf">Omega_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the curvature density parameter Omega_k at a given redshift.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The curvature density parameter Omega_k at redshift z.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">get_Omega</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CosmologyCalculator.Omega_DE">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.Omega_DE">[docs]</a>
    <span class="k">def</span> <span class="nf">Omega_DE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the dark energy density parameter Omega_DE at a given redshift.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The dark energy density parameter Omega_DE at redshift z.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">get_Omega</span><span class="p">(</span><span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></div>


<div class="viewcode-block" id="CosmologyCalculator.critical_density">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.critical_density">[docs]</a>
    <span class="k">def</span> <span class="nf">critical_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the critical density at a given redshift.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The critical density at redshift z in units of 10^10 M_sun / (h^2 Mpc^3).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">H0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;H0&#39;</span><span class="p">]</span>  <span class="c1"># Hubble parameter today in km/s/Mpc</span>
        <span class="n">H_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">hubble_parameter</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>  <span class="c1"># H(z) in km/s/Mpc</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">6.67430e-11</span>  <span class="c1"># Gravitational constant in m^3 kg^-1 s^-2</span>
        <span class="n">Mpc_to_m</span> <span class="o">=</span> <span class="mf">3.085677581491367e22</span>  <span class="c1"># Conversion from Mpc to meters</span>
        <span class="n">Msun_to_kg</span> <span class="o">=</span> <span class="mf">1.98847e30</span>  <span class="c1"># Solar mass to kg</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">H0</span> <span class="o">/</span> <span class="mi">100</span>

        <span class="c1"># Convert H(z) to SI units (1/s)</span>
        <span class="n">H_z_si</span> <span class="o">=</span> <span class="n">H_z</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">Mpc_to_m</span>  <span class="c1"># km/s/Mpc to 1/s</span>

        <span class="c1"># Critical density in SI units (kg/m^3)</span>
        <span class="n">rho_crit_si</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">H_z_si</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">G</span><span class="p">)</span>

        <span class="c1"># Convert to 10^10 M_sun / (h^2 Mpc^3)</span>
        <span class="n">rho_crit</span> <span class="o">=</span> <span class="n">rho_crit_si</span> <span class="o">*</span> <span class="n">Mpc_to_m</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">Msun_to_kg</span> <span class="o">*</span> <span class="mf">1e-10</span> <span class="o">/</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">rho_crit</span></div>

    
<div class="viewcode-block" id="CosmologyCalculator.H">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.H">[docs]</a>
    <span class="k">def</span> <span class="nf">H</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Hubble parameter H at a given redshift.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The Hubble parameter H(z) in km/s/Mpc at redshift z.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cosmo</span><span class="o">.</span><span class="n">hubble_parameter</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CosmologyCalculator.peak_height">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.peak_height">[docs]</a>
    <span class="k">def</span> <span class="nf">peak_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the peak-height delta_c / sigma(R(M), z).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        M : float</span>
<span class="sd">            Mass in solar masses over h.</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The peak-height.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Om_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega_m</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">delta_c_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_c</span><span class="p">(</span><span class="n">Om_z</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrangian_radius</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="n">sigma_R_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">delta_c_z</span> <span class="o">/</span> <span class="n">sigma_R_z</span></div>

    
<div class="viewcode-block" id="CosmologyCalculator.lagrangian_radius">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.lagrangian_radius">[docs]</a>
    <span class="k">def</span> <span class="nf">lagrangian_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the radius of the Lagrangian patch corresponding to a given mass M.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        M : float</span>
<span class="sd">            Mass in solar masses over h.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The Lagrangian radius in Mpc/h.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rho_m0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical_density</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega_m</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e10</span>  <span class="c1"># in M_sun / Mpc^3 * h^2</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">M</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rho_m0</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">R</span></div>

    
<div class="viewcode-block" id="CosmologyCalculator.sigma">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.sigma">[docs]</a>
    <span class="k">def</span> <span class="nf">sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the RMS fluctuation sigma(R, z).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        R : float</span>
<span class="sd">            Radius in Mpc/h.</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The RMS fluctuation sigma.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">sigma_squared</span> <span class="o">=</span> <span class="n">ssq_given_Dk</span><span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dk</span><span class="p">[</span><span class="n">z</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_squared</span><span class="p">)</span></div>


<div class="viewcode-block" id="CosmologyCalculator.dlnsigma_dlnR">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.dlnsigma_dlnR">[docs]</a>
    <span class="k">def</span> <span class="nf">dlnsigma_dlnR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the derivative of the logarithm of sigma with respect to the logarithm of R.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        R : float</span>
<span class="sd">            Radius in Mpc/h.</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The derivative dln(sigma)/dln(R).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">d_sigma_dR</span> <span class="o">=</span> <span class="n">d_s_given_Dk</span><span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Dk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sigma_R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Avoiding newaxis to create a matrix when multiplying </span>
        <span class="k">return</span> <span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">/</span> <span class="n">sigma_R</span><span class="p">)</span> <span class="o">*</span> <span class="n">d_sigma_dR</span></div>

    
<div class="viewcode-block" id="CosmologyCalculator.vfv">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.vfv">[docs]</a>
    <span class="k">def</span> <span class="nf">vfv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">return_variables</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">halo_finder</span><span class="o">=</span><span class="n">best_fit_values_ROCKSTAR</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the multiplicity function, defined as νf(ν), where ν is the peak-height, as well as </span>
<span class="sd">        related variables for a given mass and redshift.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        M : np.ndarray</span>
<span class="sd">            Mass of the halos in solar masses over h. </span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift. </span>
<span class="sd">        return_variables : bool, optional</span>
<span class="sd">            If True, returns additional intermediate variables used in the calculation.</span>
<span class="sd">            If False, returns only the multiplicity function. Default is False.</span>
<span class="sd">        halo_finder : str, optional</span>
<span class="sd">            Descriptor for the best-fit values for the mass function parameters.</span>
<span class="sd">            Default is `ROCKSTAR`. Options are: `AHF`, `ROCKSTAR`, `SUBFIND`, and `VELOCIraptor`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        np.ndarray or tuple</span>
<span class="sd">            If `return_variables` is False, returns an array of the multiplicity function νf(ν).</span>
<span class="sd">            If `return_variables` is True, returns a tuple containing:</span>
<span class="sd">            - M : Mass array</span>
<span class="sd">            - R : Lagrangian radius array corresponding to M</span>
<span class="sd">            - v : Peak-height array</span>
<span class="sd">            - dlnsdlnR : Derivative of log sigma with respect to log R</span>
<span class="sd">            - f(ν) : Multiplicity function values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Masses should be an instance of numpy.ndarray&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">M</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Masses size should be at least 2 (preferrebly much more).&quot;</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrangian_radius</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_height</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">dlnsdlnR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlnsigma_dlnR</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_variables</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dlnsdlnR</span><span class="p">,</span> <span class="n">multiplicity_function</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dlnsdlnR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega_m</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">best_fits</span><span class="p">[</span><span class="n">halo_finder</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">multiplicity_function</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dlnsdlnR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega_m</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">halo_finder</span><span class="p">)</span></div>


<div class="viewcode-block" id="CosmologyCalculator.dndlnM">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.dndlnM">[docs]</a>
    <span class="k">def</span> <span class="nf">dndlnM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">halo_finder</span><span class="o">=</span><span class="s1">&#39;ROCKSTAR&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the halo mass function, dn/dlnM, which gives the number density of halos </span>
<span class="sd">        per logarithmic mass interval.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        M : np.ndarray</span>
<span class="sd">            Mass of the halos in solar masses over h. </span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift. </span>
<span class="sd">        halo_finder : str, optional</span>
<span class="sd">            Descriptor for the best-fit values for the mass function parameters.</span>
<span class="sd">            Default is `ROCKSTAR`. Options are: `AHF`, `ROCKSTAR`, `SUBFIND`, and `VELOCIraptor`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            The halo mass function dn/dlnM, with units of number density per logarithmic mass interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dlnsdlnR</span><span class="p">,</span> <span class="n">vfv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vfv</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">halo_finder</span><span class="o">=</span><span class="n">halo_finder</span><span class="p">,</span> <span class="n">return_variables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical_density</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega_m</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e10</span> <span class="o">/</span> <span class="n">M</span> <span class="o">*</span> <span class="n">vfv</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">))</span></div>

    

<div class="viewcode-block" id="CosmologyCalculator.pbs_bias">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.pbs_bias">[docs]</a>
    <span class="k">def</span> <span class="nf">pbs_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">halo_finder</span><span class="o">=</span><span class="s1">&#39;ROCKSTAR&#39;</span><span class="p">,</span> <span class="n">return_variables</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the PBS bias for halos of mass M at redshift z.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        M : np.ndarray</span>
<span class="sd">            Mass of the halos in solar masses over h. </span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>
<span class="sd">        halo_finder : str</span>
<span class="sd">            The halo finder used to determine the best-fit parameters. Default is &#39;ROCKSTAR&#39;.</span>
<span class="sd">        return_variables : bool, optional</span>
<span class="sd">            If True, returns additional intermediate variables used in the calculation.</span>
<span class="sd">            If False, returns only the bias. Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        np.ndarray or tuple</span>
<span class="sd">            If `return_variables` is False, returns an array of the PBS bias.</span>
<span class="sd">            If `return_variables` is True, returns a tuple containing:</span>
<span class="sd">            - M : Mass array</span>
<span class="sd">            - R : Lagrangian radius array corresponding to M</span>
<span class="sd">            - v : Peak-height array</span>
<span class="sd">            - dlnsdlnR : Derivative of log sigma with respect to log R</span>
<span class="sd">            - vfv : Multiplicity function values</span>
<span class="sd">            - bias : PBS bias values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dlnsdlnR</span><span class="p">,</span> <span class="n">vfv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vfv</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">halo_finder</span><span class="o">=</span><span class="n">halo_finder</span><span class="p">,</span> <span class="n">return_variables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">delta_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Omega_m</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        
        <span class="c1"># Avoid division by zero or log of zero issues</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">vfv</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid values in v or vfv arrays; check input mass or redshift ranges.&quot;</span><span class="p">)</span>
        
        <span class="n">bias</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">delta_c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vfv</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">return_variables</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dlnsdlnR</span><span class="p">,</span> <span class="n">vfv</span><span class="p">,</span> <span class="n">bias</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bias</span></div>


<div class="viewcode-block" id="CosmologyCalculator.bias">
<a class="viewcode-back" href="../../api/modules.html#cctoolkit.cosmology.CosmologyCalculator.bias">[docs]</a>
    <span class="k">def</span> <span class="nf">bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">halo_finder</span><span class="o">=</span><span class="s1">&#39;ROCKSTAR&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the corrected linear halo bias.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        M : np.ndarray</span>
<span class="sd">            Mass of the halos in solar masses over h. Can be a scalar or array.</span>
<span class="sd">        z : float</span>
<span class="sd">            Redshift.</span>
<span class="sd">        halo_finder : str</span>
<span class="sd">            The halo finder used to determine the best-fit parameters. Default is &#39;ROCKSTAR&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            The corrected linear halo bias.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dlnsdlnR</span><span class="p">,</span> <span class="n">vfv</span><span class="p">,</span> <span class="n">b_pbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbs_bias</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">halo_finder</span><span class="o">=</span><span class="n">halo_finder</span><span class="p">,</span> <span class="n">return_variables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Omz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Omega_m</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">S8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Omega_m</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">/</span><span class="mf">0.3</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">corrected_bias</span><span class="p">(</span><span class="n">b_pbs</span><span class="p">,</span> <span class="n">Omz</span><span class="p">,</span> <span class="n">dlnsdlnR</span><span class="p">,</span> <span class="n">S8</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tiago Castro.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>